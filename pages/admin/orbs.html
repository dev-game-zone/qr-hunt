<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Scavenger Hunt â€“ ORBs Holding Page</title>
  <link rel="stylesheet" href="../../styles/styles.css">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body {
      background: #fafafa;
      margin: 0;
      height: 100vh;
      overflow: hidden;
    }
    #floating-orbs {
      position: fixed;
      top: 50%;
      left: 50%;
      width: 400px;
      height: 300px;
      transform: translate(-50%, -50%);
      pointer-events: none;
      z-index: 9998;
      overflow: visible;
    }
  </style>
</head>
<body>
  <div id="floating-orbs"></div>
  <div style="text-align:center;margin-top:20px;">
    <button id="startDraw" style="font-size:1.1em;padding:8px 24px;border-radius:8px;background:#ffcc00;color:#222;border:none;box-shadow:0 2px 8px #ccc;cursor:pointer;">Start Draw</button>
    <div id="winner-msg" style="margin-top:12px;font-size:1.2em;color:#008800;"></div>
  </div>
  <script>
      const startDrawBtn = document.getElementById("startDraw");
      const winnerMsg = document.getElementById("winner-msg");
    const floatingOrbs = document.getElementById("floating-orbs");
    let registeredCodes = [];

    function loadCodes() {
      registeredCodes = JSON.parse(localStorage.getItem("tombolaCodes") || "[]");
    }

    function renderFloatingOrbs() {
      floatingOrbs.innerHTML = "";
      const placedOrbs = [];
      const orbSize = 60;
      const buffer = 20;
      registeredCodes.forEach(code => {
        const orb = document.createElement("div");
        orb.className = "letter-box orb-dynamic";
        orb.textContent = code;
        let tries = 0;
        let left, top, collides;
        do {
          left = Math.random() * (floatingOrbs.clientWidth - orbSize);
          top = Math.random() * (floatingOrbs.clientHeight - orbSize);
          // Use center positions for collision check
          const centerLeft = left + orbSize / 2;
          const centerTop = top + orbSize / 2;
          collides = placedOrbs.some(o => {
            const dx = o.centerLeft - centerLeft;
            const dy = o.centerTop - centerTop;
            return Math.sqrt(dx*dx + dy*dy) < (orbSize + buffer);
          });
          tries++;
        } while (collides && tries < 200);
        orb.style.left = `${left}px`;
        orb.style.top = `${top}px`;
        placedOrbs.push({centerLeft: left + orbSize / 2, centerTop: top + orbSize / 2});
        floatingOrbs.appendChild(orb);
      });
      winnerMsg.textContent = "";
      document.querySelectorAll("#floating-orbs .letter-box").forEach(o => o.classList.remove("winner", "glow"));
        startDrawBtn.onclick = () => {
          if (!registeredCodes.length) {
            winnerMsg.textContent = "âš ï¸ No registered codes.";
            return;
          }
          const winner = registeredCodes[Math.floor(Math.random() * registeredCodes.length)];
          winnerMsg.textContent = `ðŸŽ‰ Winner: ${winner}`;
          // Highlight winner orb
          const winnerOrb = Array.from(document.querySelectorAll("#floating-orbs .letter-box")).find(orb => orb.textContent === winner);
          if (winnerOrb) {
            winnerOrb.classList.add("winner", "glow");
            winnerOrb.style.zIndex = 10001;
          }
        };
    }

    function animateFloatingOrbs() {
      const orbs = document.querySelectorAll("#floating-orbs .letter-box");
      orbs.forEach(orb => {
        const dx = (Math.random() - 0.5) * 3.0;
        const dy = (Math.random() - 0.5) * 3.0;
        let left = parseFloat(orb.style.left) + dx;
        let top = parseFloat(orb.style.top) + dy;
        left = Math.max(0, Math.min(orb.parentElement.clientWidth - 60, left));
        top = Math.max(0, Math.min(orb.parentElement.clientHeight - 60, top));
        orb.style.left = left + "px";
        orb.style.top = top + "px";
      });
      requestAnimationFrame(animateFloatingOrbs);
    }

    function updateOrbs() {
      loadCodes();
      renderFloatingOrbs();
    }

    window.addEventListener("storage", updateOrbs);
    window.addEventListener("DOMContentLoaded", () => {
      updateOrbs();
      animateFloatingOrbs();
      // Optionally, auto-refresh every 10s in case storage event doesn't fire
      setInterval(updateOrbs, 10000);
    });
  </script>
</body>
</html>
