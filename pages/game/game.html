<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Scavenger Hunt â€“ Game</title>
  <link rel="stylesheet" href="../../styles/styles.css">
</head>
<body class="game">
<main>
  <h2>Find the QR codes to reveal the letters!</h2>

  <!-- Letter progress area -->
  <div id="letters-container"></div>
  <p id="progress-text">Found 0 of 0 letters</p>

  <!-- Buttons -->
  <div class="button-group">
    <button id="scan">Scan QR Code</button>
    <button id="reset">Reset Progress</button>
  </div>

  <!-- Completion area -->
  <div id="completion">
    <span class="completion-label">Your completion code:</span><br>
    <span id="completion-code"></span>
  </div>

  <p id="msg"></p>
</main>

<!-- Scripts -->
<script src="../../scripts/config.js"></script>
<script src="../../scripts/app.js"></script>
<script>
window.addEventListener("DOMContentLoaded", async () => {
  const lettersContainer = document.getElementById("letters-container");
  const progressText = document.getElementById("progress-text");
  const completionCodeEl = document.getElementById("completion-code");
  const scanBtn = document.getElementById("scan");
  const resetBtn = document.getElementById("reset");
  const msg = document.getElementById("msg");

  if (sessionStorage.getItem("access") !== "granted") {
    window.location.href = CONFIG.BASE_PATH + "index.html";
    return;
  }

  const allLetters = Object.values(CONFIG.LETTER_MAP);
  const totalLetters = allLetters.length;

  function renderLetters() {
    const collected = store.letters;
    lettersContainer.innerHTML = "";
    allLetters.forEach(letter => {
      const div = document.createElement("div");
      div.className = "letter-box";
      div.textContent = letter;
      if (collected.includes(letter)) div.classList.add("collected");
      lettersContainer.appendChild(div);
    });
    progressText.textContent = `Found ${collected.length} of ${totalLetters} letters`;
  }

  async function checkCompletion() {
    const collected = store.letters;
    if (collected.length === totalLetters) {
      const code = await generateCompletionCode(CONFIG.HIDDEN_PHRASE);
      completionCodeEl.textContent = code;
      completionCodeEl.classList.add("visible", "glow");

      // Only trigger confetti once per user
      if (!localStorage.getItem("completed")) {
        launchConfetti();
        localStorage.setItem("completed", "true");
      }
    } else {
      completionCodeEl.textContent = "";
      completionCodeEl.classList.remove("visible", "glow");
      localStorage.removeItem("completed");
    }
  }

  resetBtn.onclick = () => {
    store.reset();
    renderLetters();
    checkCompletion();
    msg.textContent = "Progress cleared!";
  };

  scanBtn.onclick = () => {
    window.location.href = CONFIG.BASE_PATH + "pages/scan/scan.html";
  };

  renderLetters();
  checkCompletion();
});


// ðŸŽ‰ Confetti Effect
function launchConfetti() {
  const canvas = document.createElement("canvas");
  canvas.id = "confetti-canvas";
  document.body.appendChild(canvas);
  const ctx = canvas.getContext("2d");

  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;

  const confetti = [];
  const colors = ["#ff0", "#0f0", "#00f", "#f00", "#ff69b4", "#ffa500"];

  for (let i = 0; i < 120; i++) {
    confetti.push({
      x: Math.random() * canvas.width,
      y: Math.random() * canvas.height - canvas.height,
      r: Math.random() * 6 + 4,
      color: colors[Math.floor(Math.random() * colors.length)],
      speed: Math.random() * 3 + 2,
    });
  }

  let frame;
  function draw() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    confetti.forEach(p => {
      ctx.beginPath();
      ctx.arc(p.x, p.y, p.r, 0, Math.PI * 2);
      ctx.fillStyle = p.color;
      ctx.fill();
      p.y += p.speed;
      if (p.y > canvas.height) p.y = -10;
    });
    frame = requestAnimationFrame(draw);
  }

  draw();

  setTimeout(() => {
    cancelAnimationFrame(frame);
    canvas.remove();
  }, 3000);
}
</script>
</body>
</html>
