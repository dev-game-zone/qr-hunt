<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Scavenger Hunt â€“ Game</title>
  <link rel="stylesheet" href="../../styles/styles.css">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body class="game">
<main>
  <h2>Find the QR codes to reveal the letters!</h2>

  <!-- Visual letter progress -->
  <p id="progress">Letters found:</p>
  <div id="letters-container"></div>

  <!-- Progress count + completion area -->
  <div id="completion"></div>

  <!-- Buttons -->
  <div class="button-group">
    <button id="scan">Scan QR Code</button>
    <button id="reset">Reset Progress</button>
  </div>

  <p id="msg"></p>
</main>

<script src="../../scripts/config.js"></script>
<script src="../../scripts/app.js"></script>
<script src="../../scripts/qrcode.min.js"></script>

<script>
window.addEventListener("DOMContentLoaded", () => {
  const lettersContainer = document.getElementById("letters-container");
  const msg = document.getElementById("msg");
  const scanBtn = document.getElementById("scan");
  const resetBtn = document.getElementById("reset");
  const completion = document.getElementById("completion");

  // Access guard
  if (sessionStorage.getItem("access") !== "granted") {
    window.location.href = CONFIG.BASE_PATH + "index.html";
    return;
  }

  const HIDDEN = (CONFIG.HIDDEN_PHRASE || "").split("");

  function countIn(arr, ch) {
    return arr.reduce((n, x) => n + (x === ch ? 1 : 0), 0);
  }

  function renderLetters() {
    lettersContainer.innerHTML = "";
    const collected = store.letters;

    HIDDEN.forEach((letter, i) => {
      const box = document.createElement("div");
      box.textContent = letter;
      box.classList.add("letter-box");

      const requiredUpToThis = countIn(HIDDEN.slice(0, i + 1), letter);
      const collectedCount = countIn(collected, letter);

      if (collectedCount >= requiredUpToThis) {
        box.classList.add("collected");
      }

      lettersContainer.appendChild(box);
    });

    updateCompletion(collected);
  }

  async function updateCompletion(collected) {
    const requiredTotal = HIDDEN.length;
    const collectedCount = Math.min(collected.length, requiredTotal);

    // Default progress message
    completion.innerHTML = `<p class="progress-text">Progress: <strong>${collectedCount}</strong> / ${requiredTotal}</p>`;

    // All letters found
    if (collectedCount >= requiredTotal) {
      const code = await generateCompletionCode(HIDDEN.join(""));

      completion.innerHTML = `
        <p class="success">ðŸŽ‰ All letters found!</p>
        <p class="completion-label">Your completion code:</p>
        <span id="completion-code" class="copyable">${code}</span>
        <p id="copy-msg" class="copy-msg"></p>
      `;

      const codeEl = document.getElementById("completion-code");
      const copyMsg = document.getElementById("copy-msg");

      codeEl.addEventListener("click", async () => {
        try {
          await navigator.clipboard.writeText(code);
          copyMsg.textContent = "âœ… Copied!";
          setTimeout(() => (copyMsg.textContent = ""), 1500);
        } catch {
          copyMsg.textContent = "âš ï¸ Could not copy.";
        }
      });
    }
  }

  resetBtn.onclick = () => {
    store.reset();
    renderLetters();
    msg.textContent = "Progress cleared!";
  };

  scanBtn.onclick = () => {
    window.location.href = CONFIG.BASE_PATH + "pages/scan/scan.html";
  };

  window.addEventListener("storage", renderLetters);
  renderLetters();
});
</script>
</body>
</html>
