<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Scavenger Hunt Game</title>
<link rel="stylesheet" href="/styles/styles.css">
<script src="/scripts/config.js"></script>
<script src="/scripts/app.js"></script>
</head>
<body>
<main>
  <h2>Scavenger Hunt</h2>
  <div id="maskedWord">_ _ _ _ _ _ _ _ _ _</div>
  <div id="letters">No letters found yet.</div>
  <button onclick="window.location.href='/pages/scan/scan.html'">Scan QR Code</button>
  <input id="guess" placeholder="Enter final word/phrase">
  <button id="submit">Check</button>
  <p id="status"></p>
  <p id="codeOut" class="code"></p>
  <button id="reset">Reset progress</button>
</main>

<script>
if (sessionStorage.getItem("access") !== "granted") window.location.href = "/index.html";

// Hangman-style display
function getMaskedWord() {
  const found = store.letters;
  return CONFIG.HIDDEN_PHRASE
    .split('')
    .map(c => (found.includes(c) ? c : '_'))
    .join(' ');
}

function refreshDisplay() {
  const maskedWordDiv = document.getElementById('maskedWord');
  maskedWordDiv.textContent = getMaskedWord();

  const lettersDiv = document.getElementById('letters');
  lettersDiv.textContent = store.letters.length
    ? 'Letters found: ' + store.letters.join(' ')
    : 'Letters found: none';

  checkCompletion();
}

// Check if word is complete
async function checkCompletion() {
  if(getMaskedWord().replace(/ /g,'') === CONFIG.HIDDEN_PHRASE) {
    const code = await generateCompletionCode(CONFIG.HIDDEN_PHRASE);
    document.getElementById('status').textContent = "âœ… Word complete!";
    document.getElementById('codeOut').textContent = "Your completion code: " + code;
  }
}

refreshDisplay();

// Submission button
document.getElementById("submit").onclick = async () => {
  const guess = document.getElementById("guess").value.trim();
  if (!guess) return;
  const finalCode = await generateCompletionCode(guess);
  document.getElementById("status").textContent = "Solved!";
  document.getElementById("codeOut").textContent = "Your completion code: " + finalCode;
};

// Reset
document.getElementById("reset").onclick = () => {
  store.reset();
  refreshDisplay();
  document.getElementById("status").textContent = "";
  document.getElementById("codeOut").textContent = "";
};

// Update letters from other tabs
window.addEventListener('storage', e => {
  if(e.key === 'lettersUpdated') refreshDisplay();
});
</script>
</body>
</html>
