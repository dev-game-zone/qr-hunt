<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Scavenger Hunt ‚Äì Access</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="styles/styles.css">
  <link rel="icon" type="image/png" href="./favicon.png">
  <style>
    /* Show typed input in uppercase but keep placeholder in Camel Case */
    #code { text-transform: uppercase; }
    #code::placeholder { text-transform: none; color: #999; }

    /* GIF overlay */
    #detective-gif {
      position: fixed;
      display: none;
      pointer-events: none;
      z-index: 30;
      transform-origin: center center;
    }
  </style>
</head>

<body class="home">

  <!-- Detective Lottie Animation -->
  <div id="detective-animation"></div>
  <!-- Detective GIF overlay -->
  <img id="detective-gif" src="pages/images/detective_pop.gif">

  <!-- Lottie Player -->
  <script src="https://unpkg.com/lottie-web/build/player/lottie.min.js"></script>
  <script>
    const detective = document.getElementById('detective-animation');
    const detectiveGif = document.getElementById('detective-gif');

    // Load Lottie animation
    lottie.loadAnimation({
      container: detective,
      renderer: 'svg',
      loop: true,
      autoplay: true,
      path: 'pages/images/detective_search.json'
    });

    // Mobile-friendly sizing
    let detectiveWidth = Math.min(180, window.innerWidth * 0.20);
    detective.style.width = detectiveWidth + 'px';
    detective.style.height = detectiveWidth + 'px';
    detectiveGif.style.width = detectiveWidth + 'px';
    detectiveGif.style.height = detectiveWidth + 'px';

    const speed = window.innerWidth * 0.02; // proportional speed
    let direction = -1; // -1 = right-to-left start
    let x = -detectiveWidth;

    const minY = window.innerHeight * 0.55;
    const maxY = window.innerHeight * 0.7;
    let y = minY + Math.random() * (maxY - minY);

    detective.style.position = 'fixed';
    detective.style.top = `${y}px`;
    detective.style.left = `${x}px`;
    detective.style.transform = 'rotateY(180deg)'; // face right initially

    let gifPlaying = false;

    // Function to play GIF at current detective position
    function playGifAtCurrentPosition() {
      if (gifPlaying) return;
      gifPlaying = true;

      // Position GIF overlay exactly over detective
      detectiveGif.style.left = detective.style.left;
      detectiveGif.style.top = detective.style.top;

      // Flip GIF according to direction and preserve size
      detectiveGif.style.transform = direction === 1 ? 'scaleX(-1)' : 'scaleX(1)';
      detectiveGif.style.width = detective.style.width;
      detectiveGif.style.height = detective.style.height;

      // Hide Lottie temporarily
      detective.style.visibility = 'hidden';
      detectiveGif.style.display = 'block';

      // Save current movement state
      const savedX = x;
      const savedY = y;
      const savedDirection = direction;

      // Duration of GIF playback
      setTimeout(() => {
        detectiveGif.style.display = 'none';
        detective.style.visibility = 'visible';
        x = savedX;
        y = savedY;
        direction = savedDirection;
        gifPlaying = false;
      }, 1000);
    }

    function animate() {
      if (gifPlaying) {
        requestAnimationFrame(animate);
        return;
      }

      const delta = speed / 90;
      x += delta * direction;
      detective.style.left = `${x}px`;

      // subtle vertical sway
      const sway = Math.sin(x / 50) * 5;
      detective.style.top = `${y + sway}px`;

      // Offscreen ‚Üí teleport & randomize y with slight lean
      if (direction === 1 && x > window.innerWidth) {
        direction = -1;
        x = window.innerWidth;
        y = minY + Math.random() * (maxY - minY);
        detective.style.top = `${y}px`;
        detective.style.transform = 'rotateY(0deg) rotateZ(-5deg)';
      }
      if (direction === -1 && x < -detectiveWidth) {
        direction = 1;
        x = -detectiveWidth;
        y = minY + Math.random() * (maxY - minY);
        detective.style.top = `${y}px`;
        detective.style.transform = 'rotateY(180deg) rotateZ(5deg)';
      }

      // Rare random GIF trigger (~0.05% per frame)
      if (Math.random() < 0.0005) playGifAtCurrentPosition();

      requestAnimationFrame(animate);
    }

    requestAnimationFrame(animate);

    // Adjust size on resize
    window.addEventListener('resize', () => {
      detectiveWidth = Math.min(180, window.innerWidth * 0.20);
      detective.style.width = detectiveWidth + 'px';
      detective.style.height = detectiveWidth + 'px';
      detectiveGif.style.width = detectiveWidth + 'px';
      detectiveGif.style.height = detectiveWidth + 'px';
    });
  </script>

  <main>
    <h2>Enter Today‚Äôs Access Code</h2>
    <p>Please enter the daily access code to begin the scavenger hunt.</p>

    <div class="admin-input-row" style="max-width:400px; margin:0 auto;">
      <input id="code" type="text" placeholder="Access Code" autocomplete="off" autofocus>
    </div>

    <div class="button-group">
      <button id="enter">Enter</button>
    </div>

    <p id="msg"></p>
  </main>

  <!-- üß© SHA256 fallback -->
  <script>
    if (typeof sha256 === "undefined") {
      async function sha256(text) {
        const buf = await crypto.subtle.digest("SHA-256", new TextEncoder().encode(text));
        return Array.from(new Uint8Array(buf))
          .map(b => b.toString(16).padStart(2, "0"))
          .join("")
          .toUpperCase();
      }
      console.log("‚öôÔ∏è sha256 fallback loaded");
    }
  </script>

  <!-- App Scripts -->
  <script src="scripts/config.js"></script>
  <script src="scripts/app.js"></script>

  <script>
    window.addEventListener("DOMContentLoaded", () => {
      const codeInput = document.getElementById("code");
      const msg = document.getElementById("msg");
      const enterBtn = document.getElementById("enter");

      if (sessionStorage.getItem("access") === "granted") {
        window.location.href = "pages/game/game.html";
        return;
      }

      enterBtn.onclick = async () => {
        try {
          const code = codeInput.value.trim();
          const ok = await verifyAccessCode(code);
          if (ok) {
            sessionStorage.setItem("access", "granted");
            window.location.href = "pages/game/game.html";
          } else {
            msg.textContent = "‚ùå Incorrect code. Try again.";
          }
        } catch (err) {
          console.error(err);
          msg.textContent = "‚ö†Ô∏è There was a problem verifying the code.";
        }
      };
    });
  </script>

</body>
</html>
