<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Scavenger Hunt – Access</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="styles/styles.css">
  <link rel="icon" type="image/png" href="./favicon.png">
  <style>
    /* ================================
       GIF overlay
    ================================= */
    #detective-gif {
      position: fixed;
      display: none;
      pointer-events: none;
      z-index: 30;
      transform-origin: center center;
      object-fit: fill;
    }
  </style>
</head>

<body class="home">

  <!-- Detective Lottie Animation -->
  <div id="detective-animation"></div>
  <!-- Detective GIF overlay -->
  <img id="detective-gif" src="pages/images/detective_pop.gif">

  <!-- Lottie Player -->
  <script src="https://unpkg.com/lottie-web/build/player/lottie.min.js"></script>
  <script>
    const detective = document.getElementById('detective-animation');
    const detectiveGif = document.getElementById('detective-gif');

    lottie.loadAnimation({
      container: detective,
      renderer: 'svg',
      loop: true,
      autoplay: true,
      path: 'pages/images/detective_search.json'
    });

    let detectiveWidth = Math.min(180, window.innerWidth * 0.20);
    detective.style.width = detectiveWidth + 'px';
    detective.style.height = detectiveWidth + 'px';
    detectiveGif.style.width = detectiveWidth + 'px';
    detectiveGif.style.height = detectiveWidth + 'px';

    const speed = window.innerWidth * 0.02;
    let direction = -1;
    let x = -detectiveWidth;

    const minY = window.innerHeight * 0.55;
    const maxY = window.innerHeight * 0.7;
    let y = minY + Math.random() * (maxY - minY);

    detective.style.position = 'fixed';
    detective.style.top = `${y}px`;
    detective.style.left = `${x}px`;
    detective.style.transform = 'rotateY(180deg)';

    let gifPlaying = false;

    function playGifAtCurrentPosition() {
      if (gifPlaying) return;
      gifPlaying = true;

      // Capture the exact position before switching
      const lottieRect = detective.getBoundingClientRect();
      
      // Set height to match, width to auto to preserve aspect ratio
      detectiveGif.style.height = `${lottieRect.height}px`;
      detectiveGif.style.width = 'auto';
      
      // Match the transform/flip direction
      detectiveGif.style.transform = direction === 1 ? 'scaleX(-1)' : 'scaleX(1)';

      // Swap visibility
      detective.style.visibility = 'hidden';
      detectiveGif.style.display = 'block';

      // Now get the actual rendered position of the GIF after it calculates its width
      const gifRect = detectiveGif.getBoundingClientRect();
      
      // Center the GIF on the Lottie's position
      const offsetX = (lottieRect.width - gifRect.width) / 2;
      const offsetY = (lottieRect.height - gifRect.height) / 2;
      detectiveGif.style.left = `${lottieRect.left + offsetX}px`;
      detectiveGif.style.top = `${lottieRect.top + offsetY}px`;

      setTimeout(() => {
        // Hide GIF and restore Lottie at the same position where it was
        detectiveGif.style.display = 'none';
        detective.style.visibility = 'visible';
        
        // Keep the position where the Lottie was (stored in lottieRect)
        // The x and y were already correct before the GIF played
        detective.style.left = `${lottieRect.left}px`;
        detective.style.top = `${lottieRect.top}px`;
        x = lottieRect.left;
        y = lottieRect.top;
        
        gifPlaying = false;
      }, 1000);
    }

    function animate() {
      if (gifPlaying) {
        requestAnimationFrame(animate);
        return;
      }

      const delta = speed / 80;
      x += delta * direction;
      detective.style.left = `${x}px`;

      const sway = Math.sin(x / 50) * 5;
      detective.style.top = `${y + sway}px`;

      if (direction === 1 && x > window.innerWidth) {
        direction = -1;
        x = window.innerWidth;
        y = minY + Math.random() * (maxY - minY);
        detective.style.top = `${y}px`;
        detective.style.transform = 'rotateY(0deg) rotateZ(-5deg)';
      }
      if (direction === -1 && x < -detectiveWidth) {
        direction = 1;
        x = -detectiveWidth;
        y = minY + Math.random() * (maxY - minY);
        detective.style.top = `${y}px`;
        detective.style.transform = 'rotateY(180deg) rotateZ(5deg)';
      }

      if (Math.random() < 0.0005) playGifAtCurrentPosition();

      requestAnimationFrame(animate);
    }

    requestAnimationFrame(animate);

    window.addEventListener('resize', () => {
      detectiveWidth = Math.min(180, window.innerWidth * 0.20);
      detective.style.width = detectiveWidth + 'px';
      detective.style.height = detectiveWidth + 'px';
      detectiveGif.style.width = detectiveWidth + 'px';
      detectiveGif.style.height = detectiveWidth + 'px';
    });
  </script>

  <main>
    <h2>Enter Today’s Access Code</h2>
    <p>Please enter the daily access code to begin the scavenger hunt.</p>

    <div class="admin-input-row">
      <input id="code" type="text" placeholder="Access Code" autocomplete="off" autofocus>
    </div>

    <div class="button-group">
      <button id="enter">Enter</button>
    </div>

    <p id="msg"></p>
  </main>

  <script>
    if (typeof sha256 === "undefined") {
      async function sha256(text) {
        const buf = await crypto.subtle.digest("SHA-256", new TextEncoder().encode(text));
        return Array.from(new Uint8Array(buf))
          .map(b => b.toString(16).padStart(2, "0"))
          .join("")
          .toUpperCase();
      }
      console.log("⚙️ sha256 fallback loaded");
    }
  </script>

  <script src="scripts/config.js"></script>
  <script src="scripts/app.js"></script>

  <script>
    window.addEventListener("DOMContentLoaded", () => {
      const codeInput = document.getElementById("code");
      const msg = document.getElementById("msg");
      const enterBtn = document.getElementById("enter");

      if (sessionStorage.getItem("access") === "granted") {
        window.location.href = "pages/game/game.html";
        return;
      }

      enterBtn.onclick = async () => {
        try {
          const code = codeInput.value.trim();
          const ok = await verifyAccessCode(code);
          if (ok) {
            sessionStorage.setItem("access", "granted");
            window.location.href = "pages/game/game.html";
          } else {
            msg.textContent = "❌ Incorrect code. Try again.";
          }
        } catch (err) {
          console.error(err);
          msg.textContent = "⚠️ There was a problem verifying the code.";
        }
      };
    });
  </script>

</body>
</html>
